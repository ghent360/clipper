<!doctype html>

<html>

  <head>
    <meta charset="utf-8">
    <title>WASM int64 test</title>
  </head>

  <body>
    <script src="wasm-util.js"></script>
    <script>
      var TwoPow32 = Math.pow(2, 32);
      function toInt64(n) {
        return { low :(n >>> 0) & 0xffffffff,
                 high :Math.trunc(n / TwoPow32) & 0xffffffff};
      }
      function fromInt64(n) {
        return (n.low >>> 0) + n.high * TwoPow32;
      }
      fetchAndInstantiate('int64.wasm').then(function(instance) {
        var int64 = {
            instance: instance,
            memory32: new Uint32Array(instance.exports.mem.buffer),
            setArg: function (n, o) {
                this.memory32[o] = n.low;
                this.memory32[o+1] = n.high;
            },
            add: function(a, b) {
                this.setArg(a, 0);
                this.setArg(b, 2);
                this.instance.exports["add64"]();
                return this.result();
            },
            result: function() {
                return {low: this.memory32[4], high: this.memory32[5]};
            }
        };
        var a = toInt64(0x1234);
        var b = toInt64(0x100000000);
        var c = int64.add(a, b);
        function dump64(n, m) {
            console.log("%s(0x%s, 0x%s)=%d", m, n.low.toString(16), n.high.toString(16), fromInt64(n));
        }
        dump64(a, "a");
        dump64(b, "b");
        dump64(c, "c");
      });
    </script>
  </body>

</html>